<html>
<head>
<title>LuaSVN</title>
</head>
<body bgcolor="white">

<h1>LuaSVN - Usando Subversion a partir de Lua</h1>
<hr>

<h3>
<a href="#Introducao">Introdu&ccedil;&atilde;o</a>
<br>
<a href="#Funcionamento_Basico">Funcionamento B&aacute;sico</a>
<br>
<a href="#API">API</a>
<br>
<a href="#Obtendo_LuaSVN">Obtendo LuaSVN</a>
<br>
<a href="#Compilando_LuaSVN">Compilando LuaSVN</a>
<br>
<a href="#Contato">Contato</a>
<br>
<a href="#Licenca">Licen&ccedil;a</a>
</h3>

<hr>

<h2><a name="Introducao">Introdu&ccedil;&atilde;o</a></h2>


<p align="justify">
<i>LuaSVN</i> &eacute; uma biblioteca que permite a utiliza&ccedil;&atilde;o de algumas funcionalidades de
<i>Subversion</i> (SVN) a partir de Lua.
</p>

<p align="justify">
<a href="http://subversion.tigris.org/">Subversion</a> &eacute; um sistema de controle de vers&otilde;es de c&oacute;digo
aberto que vem ganhando cada vez mais import&acirc;ncia, atualmente ele &eacute; o sistema de controle de vers&otilde;es
usado em mais da metade dos projetos de c&oacute;digo aberto segundo o site <a href="http://cia.vc/stats/vcs">
Cia.vc</a>.
</p>


<p align="justify">
Al&eacute;m de ser utilizado para o versionamento de c&oacute;digo fonte, Subversion tamb&eacute;m
&eacute; comumente utilizado no versionamento de p&aacute;ginas web, o que foi a motiva&ccedil;&atilde;o
inicial para o desenvolvimento de LuaSVN.
</p>

<p align="justify">
LuaSVN foi desenvolvida a partir da API C disponibilizada por Subversion e implementa um conjunto b&aacute;sico
de fun&ccedil;&otilde;es que podem ser utilizadas diretamente por um programa Lua.
</p>


<h2><a name="Funcionamento_Basico">Funcionamento B&aacute;sico</a></h2>

<p align="justify">
Subversion utiliza funcionalidades do projeto <i>Apache Portable Runtime</i> (APR), o qual prov&ecirc; uma interface
padr&atilde;o que abstrai algumas quest&otilde;es de mais baixo n&iacute;vel e que dependem da plataforma que
est&aacute; sendo utilizada.
</p>

<p align="justify">
Em virtude disto, o gerenciamento de mem&oacute;ria &eacute; feito em um <i>pool</i> da biblioteca APR, o qual &eacute;
passado como argumento para as fun&ccedil;&otilde;es da API C de Subversion. Dessa forma, uma tarefa b&aacute;sica
das fun&ccedil;&otilde;es da biblioteca LuaSVN &eacute; ent&atilde;o inicializar o <i>pool</i> de mem&oacute;ria
(atualmente cada fun&ccedil;&atilde;o cria o seu pr&oacute;prio <i>pool</i>, n&atilde;o existe um <i>pool</i>
global), o que &eacute; feito atrav&eacute; de uma chamada &agrave; fun&ccedil;&atilde;o <b>init_pool</b>, que ir&aacute;
realizar um conjunto de tarefas relacionadas com a inicializa&ccedil;&atilde;o do sistema de gerenciamento de mem&oacute;ria.
</p>

<p align="justify">
Ap&oacute;s a inicializa&ccedil;&atilde;o do <i>pool</i>, o pr&oacute;ximo passo consiste em obter um ponteiro para o
sistema de arquivos em um determinado n&uacute;mero de revis&atilde;o do sistema, isto &eacute; feito atrav&eacute;s
da fun&ccedil;&atilde;o <b>init_fs_root</b>.
</p>


<p align="justify">
Somente depois de ter realizado as duas etapas anteriores &eacute; que come&ccedil;a o c&oacute;digo relacionado com
a funcionalidade particular de uma fun&ccedil;&atilde;o.
</p>



<h2><a name="API">API</a></h2>

<p align="justify">
Toda fun&ccedil;&atilde;o de LuaSVN espera como primeiro argumento uma string <i>repos</i> representando o
endere&ccedil;o do reposit&oacute;rio Subversion que ser&aacute; acessado. Na vers&atilde;o atual (0.1),
apenas endere&ccedil;os de reposit&oacute;rios locais s&atilde;o aceitos e devem ser inseridos sem a barra (/)
final. Estes endere&ccedil;os podem ser absolutos ou relativos. Muitas fun&ccedil;&atilde;o de LuaSVN tamb&eacute;m
possuem um par&acirc;metro opcional <i>rev</i>, o qual &eacute; um n&uacute;mero inteiro, que representa o
n&uacute;mero da vers&atilde;o com a qual se deseja trabalhar. Caso esse valor n&atilde;o seja especificado, ou
caso seja igual a zero, assume-se que deseja-se trabalhar com a vers&atilde;o mais recente do reposit&oacute;rio.
</p>


<p align="justify">
O comportamento padr&atilde;o de uma fun&ccedil;&atilde;o LuaSVN em caso de erro &eacute; fazer uma chamada Ã 
fun&ccedil;&atilde;o <code>lua_error</code>.
</p>


<p align="justify">
Para usar LuaSVN, a primeira coisa a fazer &eacute; importar a biblioteca, isso pode ser feito incluindo <code>require ("luasvn")</code>
no seu programa Lua. As seguintes fun&ccedil;&otilde;es fazem parte da API de LuaSVN 0.1:
</p>

<ul>

<li><code><b>luasvn.change_file (path, file, content)</b></code>

<p align="justify">
Muda o conte&uacute;do do arquivo <i>file</i>, localizado no reposit&oacute;rio indicado por <i>path</i>, para
o texto <i>content</i>. A fun&ccedil;&atilde;o retorna o n&uacute;mero da nova vers&atilde;o do reposit&oacute;rio.
</p>

<p align="justify">Exemplo:
<br>
<code>rev = luasvn.change_file ("/home/name/myrepos", "trunk/test.txt", "new text\n")</code>
</p>



<li><code><b>luasvn.change_rev_prop (path, prop, value [, revision])</b></code>

<p align="justify">
Muda, na revis&atilde;o <i>revision</i>, o valor da propriedade indicada pela string <i>prop</i> para <i>value</i>.
Em caso de sucesso, a fun&ccedil;&atilde;o retorna <code>true</code>. Se n&atilde;o existe uma propriedade chamada
<i>prop</i>, ela ser&aacute; criada. Por outro lado, se <i>value</i> for igual a <code>nil</code>, a propriedade
ser&aacute; removida da lista de propriedades da revis&atilde;o.
</p>

<p align="justify">Exemplo:
<br>
<code>ok = luasvn.change_rev_prop ("../myrepos", "author", "teleco", 12)</code>
</p>


<li><code><b>luasvn.create_dir (path, dir)</b></code>

<p align="justify">
Cria um diret&oacute;rio chamado <i>dir</i> no reposit&oacute;rio indicado por <i>path</i>. Retorna o
n&uacute;mero da nova vers&atilde;o do reposit&oacute;rio.
</p>


<p align="justify">Exemplo:
<br>
<code>rev = luasvn.create_dir ("myrepos", "newDir")</code>
</p>



<li><code><b>luasvn.create_file (path, file)</b></code>

<p align="justify">
Cria um arquivo chamado <i>file</i> no reposit&oacute;rio indicado por <i>path</i>. A nova vers&atilde;o do
reposit&oacute;rio ser&aacute; retornada em caso de sucesso.
</p>


<p align="justify">Exemplo:
<br>
<code>rev = luasvn.create_file ("/home/name/myrepos", "newFile")</code>
</p>


<li><code><b>create_repos (path)</b></code>

<p align="justify">
Cria um reposit&oacute;rio na localiza&ccedil;&atilde;o indicada por <i>path</i>. Ocorrer&aacute; um erro caso
j&aacute; existe um reposit&oacute;rio no caminho indicado. 
</p>


<p align="justify">Exemplo:
<br>
<code>luasvn.create_repos ("test")</code>
</p>



<li><code><b>delete_repos (path)</b></code>

<p align="justify">
Apaga o reposi&oacute;rio cuja localiza&ccedil;&atilde;o &eacute; indicada por <i>path</i>.
Caso o reposit&oacute;rio n&atilde;o existe, ocorr&aacute; um erro.
</p>


<p align="justify">Exemplo:
<br>
<code>luasvn.delete_repos ("/home/name/test")</code>
</p>


<li><code><b>luasvn.file_exists (path, file [, revision])</b></code>

<p align="justify">
Verifica se um arquivo chamado <i>file</i> existe no reposit&oacute;rio indicado por <i>path</i>. Em caso de sucesso,
um valor booleano indicando se o arquivo existe ou n&atilde;o, &eacute; retornado. 
</p>


<p align="justify">Exemplo:
<br>
<code>exists = luasvn.file_exists ("/home/name/myrepos", "file", 15)</code>
</p>



<li><code><b>luasvn.get_file_content (path, file [, revision])</b></code>

<p align="justify">
Retorna o conte&uacute;do do arquivo <i>file</i>. Se o arquivo acabou de ser criado, o seu cont&uacute;do
ser&aacute; igual a <code>""</code>.
</p>


<p align="justify">Exemplo:
<br>
<pre>
content = luasvn.get_file_content ("/home/name/myrepos", "file")

print ("Conte&uacute;do do arquivo:", content)
</pre>
</p>



<li><code><b>luasvn.get_file_history (path, file [, revision])</b></code>

<p align="justify">
Retorna uma lista indexada cujos &iacute;ndices representam o n&uacute;mero de uma vers&atilde;o na qual <i>file</i>
foi modificado. Associado a cada &iacute;ndice, temos o nome que o arquivo possu&iacute;a naquela determinada vers&atilde;o. 
</p>


<p align="justify">Exemplo:
<br>
<pre>
t = luasvn.get_file_history ("/home/name/myrepos", "trunk/old.txt", 22)

for rev, name in pairs (t) do
    print (rev, name)
end
</pre>
</p>


<li><code><b>luasvn.get_files (path, dir [, revision])</b></code>

<p align="justify">
Retorna uma tabela contendo todos os arquivos do diret&oacute;rio <i>dir</i>. Os elementos da tabela s&atilde;o indexados
pelo nome de um arquivo e est&atilde;o associados ao n&uacute;mero da revis&atilde;o na qual o arquivo foi modificado pela
&uacute;ltima vez.
</p>


<p align="justify">Exemplo:
<br>
<pre>
t = luasvn.get_files ("/home/name/myrepos", "") --"" &eacute; o diret&oacute;rio raiz

for name, rev in pairs (t) do
    print (name, rev)
end
</pre>
</p>


<li><code><b>luasvn.get_rev_proplist (path, [, revision])</b></code>

<p align="justify">
Em caso de sucesso, retorna uma tabela indexada pelos nomes das propriedades, onde o nome de uma
propriedade est&aacute; associado ao valor correspondente. 
</p>


<p align="justify">Exemplo:
<br>
<pre>
t = luasvn.get_rev_proplist ("myrepos", 55)

for prop, v in pairs (t) do
    print (prop, v)
end
</pre>
</p>


</ul>


<h2><a name="Obtendo_LuaSVN">Obtendo LuaSVN</a></h2>

<p align="justify">
Para obter LuaSVN, clique <a href="http://luaforge.net/frs/?group_id=289">aqui</a>.
</p>

<p align="justify">
Tamb&eacute;m &eacute; poss&iacute;vel obter LuaSVN a partir da linha de comando abaixo, caso n&atilde;o tenha o Subversion instalado ainda,
siga as instru&ccedil;&otilde;es dispon&iacute;veis na se&ccedil;&atilde;o <i>Compilando LuaSVN</i>:
<br><br>
<code>svn checkout http://luasvn.googlecode.com/svn/trunk/ luasvn</code>
</p>


<h2><a name="Compilando_LuaSVN">Compilando LuaSVN</a></h2>


<p align="justify">
Para compilar LuaSVN, voc&ecirc; precisa da vers&atilde;o 1.4 de Subversion. &Eacute; poss&iacute;vel instal&aacute;-la
na distribui&ccedil;&atilde;o Linux Ubuntu, caso voc&ecirc; tenha as devidas permiss&otilde;es, atrav&eacute;s do seguinte
comando: <code>sudo apt-get install libsvn-dev</code>. Isto tamb&eacute;m instalar&aacute; <i>libapr1-dev</i>, que &eacute;
utilizada pelo Subversion. Pode ser necess&aacute;rio tamb&eacute;m instalar <i>uuid</i>, caso este seja o caso, digite
<code>sudo apt-get install libuuid1</code>
</p>

<p align="justify">
Ap&oacute;s esta etapa, voc&ecirc; pode editar o <i>makefile</i> que vem com LuaSVN, ajustando
os caminhos necess&aacute;rios, e digitar <i>make</i>. Em seguida, copie <i>luasvn.so</i> para o diret&oacute;rio onde
Lua procura suas bibliotecas, isso depende da sua instala&ccedil;&atilde;o Lua, um lugar comum &eacute;
<i>/usr/local/lib/lua/5.1/</i>.
</p>

<p align="justify">
Caso voc&ecirc; n&atilde;o possua as devidas permiss&otilde;es do seu sistema para executar o comando acima, uma alternativa
&eacute; seguir estes passos, supondo que voc&ecirc; instalar&aacute; os arquivos no diret&oacute;rio <i>~/tmp/</i>:
</p>

<ol>

<li>
Ajuste a vari&aacute;vel <i>PREFIX</i> para o diret&oacute;rio onde a instala&ccedil;&atilde;o vai ser realizada:
<br>
<pre>
export PREFIX=/home/login/tmp
</pre>

<li>
Ajuste tamb&eacute;m <i>LD_LIBRARY_PATH</i>:
<br>
<pre>
export LD_LIBRARY_PATH=$PREFIX/lib/
</pre>

<li>
Entre no diret&oacute;rio da instala&ccedil;&atilde;o, crie os diret&oacute;rios <i>luasvn</i> e <i>lib</i>, baixe os arquivos
necess&aacute;rios e descompacte-os:
<br>
<pre>
cd ~/tmp/
mkdir luasvn
mkdir lib
wget http://mirror.pop-sc.rnp.br/mirror/apache/apr/apr-1.2.8.tar.gz
tar xvzf apr-1.2.8.tar.gz 
wget http://mirror.pop-sc.rnp.br/mirror/apache/apr/apr-util-1.2.8.tar.gz
tar xvzf apr-util-1.2.8.tar.gz 
wget http://subversion.tigris.org/downloads/subversion-1.4.3.tar.gz
tar xvzf subversion-1.4.3.tar.gz 
wget http://ufpr.dl.sourceforge.net/sourceforge/e2fsprogs/e2fsprogs-1.39.tar.gz
tar xvzf e2fsprogs-1.39.tar.gz
</pre>


<li>
Compile e instale <i>APR</i>, <i>APR-Utils</i> e <i>Subversion</i>:
<br>
<pre>
cd apr-1.2.8
./configure --prefix=$PREFIX && make && make install
cd ..
cd apr-util-1.2.8
./configure --prefix=$PREFIX --with-apr=$PREFIX && make && make install
cd ..
cd subversion-1.4.3
./configure --prefix=$PREFIX --with-apr=$PREFIX --with-apr-util=$PREFIX
make && make install
cd ..
</pre>

<li>
Talvez n&atilde;o seja necess&aacute;rio este passo, mas caso ele seja, instale <i>LibUUID</i>:
<br>
<pre>
cd e2fsprogs-1.39
./configure --prefix=$PREFIX
cd lib/uuid/
make && make install
cd ../../..
</pre>

<li>
Agora fa&ccedil;a o download de LuaSVN e compile a biblioteca:
<br>
<pre>
cd luasvn/
wget http://luasvn.googlecode.com/svn/trunk/luasvn.c
wget http://luasvn.googlecode.com/svn/trunk/makefile
nano makefile
</pre>

<li>
Edite o <i>makefile</i> de LuaSVN, ajustando o caminho dos diret&oacute;rios e depois compile:
<br>
<pre>
make
</pre>

<li>Agora voc&ecirc; pode copiar <i>luasvn.so</i> para um lugar onde a sua instala&ccedil;&atilde;o
de Lua possa enxerg&aacute;-la. Caso Lua esteja olhando bibliotecas <i>.so</i> em <i>$PREFIX/lib/lua/5.1</i>,
voc&ecirc; pode fazer:
<br>
<pre>
cp luasvn.so $PREFIX/lib/lua/5.1/
</pre>

</ol>



<h2><a name="Contato">Contato</a></h2>

<p align="justify">
LuaSVN foi desenvolvida por S&eacute;rgio Medeiros e &eacute; um software livre.
Se voc&ecirc; deseja fazer algum coment&aacute;rio ou possui alguma d&uacute;vida, por favor envie
uma mensagem para smedeiros arroba inf ponto puc-rio ponto br.
</p>



<h2><a name="Licenca">Licen&ccedil;a</a></h2>

<p align="justify">
Copyright &copy; 2007 S&eacute;rgio Medeiros.
</p>

<p align="justify">
Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
</p>

<p align="justify">
The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
</p>

<p align="justify">
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. 
</p>



</body>
</html>
